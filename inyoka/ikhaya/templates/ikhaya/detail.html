{#
    ikhaya/detail.html
    ~~~~~~~~~~~~~~~~~~

    Show a single ikhaya article.

    :copyright: (c) 2007-2011 by the Inyoka Team, see AUTHORS for more details.
    :license: GNU GPL, see LICENSE for more details.
#}
{%- extends 'ikhaya/page.html' %}
{% from 'macros.html' import render_form %}

{% do BREADCRUMB.append(article.subject, article|url, True) %}
{% set styles = ['editor-sprite']%}
{% set scripts = ['WikiEditor'] %}
{% set feed = 'feeds/comments/%s/%%s/20'|format(article.id) %}
{% set feeds = [
  ('Kommentare - Nur Überschrift', href('ikhaya', feed|format('title'))),
  ('Kommentare - Nur Einleitung', href('ikhaya', feed|format('short'))),
  ('Kommentare - Ganzer Beitrag', href('ikhaya', feed|format('full'))),
  ] %}


{% macro user_column(user) %}
  <td class="author"
  {%- if user.id == USER.id %} style="background-color: #F6F4EF"
  {%- endif %}>
    <p class="username{% if not user.is_active %} inactive{% endif %}">
      <a href="{{ user|url }}">{{ user.username|e }}</a>
      {%- if user.primary_group_id and user.primary_group.icon %}
      <img class="teamicon" src="{{ user.primary_group.icon_url }}" alt="Teamicon" />
      {%- endif %}
      {%- if user.member_title %}
      <div class="member_title">{{ user.member_title|e }}</div>
      {%- endif %}
    </p>
    {%- if user.avatar and not USER.settings['hide_avatars'] %}
    <img class="avatar" src="{{ user.avatar_url }}" alt="Avatar von {{ user.username|e }}" />
    {%- endif %}
  </td>
{% endmacro %}

{% block ikhaya_content %}
  <div class="article" id="page">
    <h3 class="title"><a href="{{ article|url }}">{{ article.subject|e }}</a></h3>
    {%- if article.article_icon -%}
    <img class="icon" src="{{ article.article_icon|url }}" alt="{{ article.article_icon.identifier|e }}" />
    {%- endif -%}
    <div class="intro">
      {{ article.rendered_intro }}
    </div>
    <div class="text">
      {{ article.rendered_text }}
    </div>
    <p class="meta admin_link_hover">
      geschrieben von <a href="{{ article.author|url }}">
      {{ article.author.username|e}}</a> {{ article.pub_datetime|specificdatetimeformat(true) }}
      in <a href="{{ article.category|url }}">{{ article.category.name|e }}</a>
      {%- if article.updated > article.pub_datetime %}
      – zuletzt aktualisiert {{ article.updated|specificdatetimeformat(true) }}
      {%- endif %}
      {% if can_edit_article %}<span class="admin_link"> – <a href="{{ article|url('edit') }}">bearbeiten</a></span>{% endif %}
      {%- if can_subscribe and article.comments_enabled %}
        {%- if is_subscribed %}
        <a href="{{ article|url('unsubscribe') }}" class="action action_unsubscribe">Kommentare abbestellen</a>
        {%- else %}
        <a href="{{ article|url('subscribe') }}" class="action action_subscribe">Kommentare abonnieren</a>
        {%- endif %}
      {%- endif %}
      <a href="{{ article|url('reports') }}" class="action action_report">Rechtschreibfehler melden</a>
    </p>
    {%- if article.comments_enabled %}
      <table id="comments" class="comments">
        {%- for comment in comments %}
        {%- if comment.deleted and not can_admin_comment %}
        {%- else %}
        <tr id="comment_{{ loop.index }}" class="admin_link_hover{% if comment.deleted %} hidden{% endif %}">
          {{ user_column(comment.author) }}
          {%- if comment.author_id == USER.id %}
          <td class="comment" style="background-color: #F8F6F1">
          {%- else %}
          <td class="comment">
          {%- endif %}
            <div class="commentinfo">
              <div class="linklist">
                {%- if comment.author_id == USER.id %}
                <a href="{{ comment|url('edit') }}" class="action action_edit">bearbeiten</a> |
                {% endif %}
                {%- if can_admin_comment %}
                  <span class="admin_link">
                  {% if comment.author_id != USER.id %}
                    <a href="{{ comment|url('edit') }}" class="admin_link action action_edit">bearbeiten</a> |
                  {% endif %}
                  {% if comment.deleted %}
                    <a href="{{ comment|url('restore') }}" class="action action_restore">wiederherstellen</a> |
                  {%- else %}
                    <a href="{{ comment|url('hide') }}" class="action action_hide">verbergen</a> |
                  {% endif %}
                  </span>
                {%- endif -%}
                {%- if can_post_comment %}
                  <a href="#new_comment" onclick="$('#id_text').val($('#id_text').val() + '@' + {{ loop.index }} + ': ')" class="action action_quote">antworten</a>
                {%- endif %}
              </div>
              <a href="#comment_{{ loop.index }}" title="Kopiere diesen Link, um auf diesen Beitrag zu verweisen" onclick="alert(this.title + '\n\n' + this.href); return false"><strong>{{ loop.index }}.</strong></a>
              Verfasst: {{ comment.pub_date|datetimeformat }}
            </div>
            <div class="text">
              {{ comment.rendered_text }}
            </div>
          </td>
        </tr>
        {%- endif %}
        {%- endfor %}
        {%- if can_post_comment %}
        <tr id="new_comment">
          {{ user_column(USER) }}
          <td>
            {{ form.errors.text }}
            <form action="{{ article|url }}#new_comment" method="post" id="new_comment">
              {{ form.text }}
              <div class="note">{{ form.fields.text.help_text }}</div>
              {% if form.data.comment_id and USER.can('comment_edit') %}
              {{ form.comment_id }}
              {% endif %}
              <p>
                <input type="submit" name="preview" value="Vorschau" />
                <input type="submit" value="Speichern" />
              </p>
              {%- if preview %}
              <div class="preview_wrapper">
                <h2 class="title">Vorschau</h2>
                <div id="preview" class="preview">{{ preview }}</div>
              </div>
              {%- endif %}
            </form>
          </td>
        </tr>
        {%- endif %}
      </table>
    {%- endif %}
  </div>
{% endblock %}

{% block additional_scripts %}
  {{ super() }}
  <script type="text/javascript">
   /* <![CDATA[ */

  $(function() {
    makeCommentLinks($('table.comments td.comment'));
  })

  {% if article.comments_enabled %}
    {%- if article.comment_count %}
      var txt = 'Kommentare ({{ article.comment_count }})'
    {%- else %}
      var txt = 'Kommentar schreiben'
    {%- endif %}
    if (document.location.href.search('#comment') == -1) {
      $('#comments').hide().before(
        $('<a class="show_comments">')
          .text(txt)
          .click(function() {
            $('#comments').toggle();
          })
      );
    }
  {% endif %}

  {% if can_post_comment %}
    var text = new WikiEditor('textarea[name="text"]', 'forum');
    (function() {
      var
        editor = $('textarea[name="text"]'),
        output = $('<div class="preview" />')
      var preview = $('<div class="preview_wrapper"  />')
        .hide()
        .append('<h2 class="title">Vorschau<\/h2>')
        .append(output);

      $('form input[name="preview"]').click(function() {
        $('body, input, textarea').css('cursor', 'progress');
        preview.hide();
        $.post('/?__service__=wiki.render_preview', {
          text: editor.val()
        }, function(data) {
          output.html(data);
          makeCommentLinks(output);
          preview.slideDown('fast');
          $('body, input, textarea').css('cursor', 'auto');
        });
        return false;
      }).parent().parent().parent().append(preview);
    })();
  {% endif %}
  /* ]]> */
</script>

{% endblock %}
