{#
    portal/usercp/profile.html
    ~~~~~~~~~~~~~~~~~~~~~~~~~~

    This page shows the user the configuration of his profile.

    :copyright: (c) 2007-2011 by the Inyoka Team, see AUTHORS for more details.
    :license: GNU GPL, see LICENSE for more details.
#}

{%- extends 'portal/usercp/overall.html' %}
{% from 'macros.html' import render_form %}
{% do BREADCRUMB.append(_('Profile'), href('portal', 'usercp', 'profile'), True) %}
{% set scripts = ['WikiEditor'] %}
{% set styles = ['editor-sprite'] %}
{% set selected = 'profile' %}

{% block portal_content %}
  <form enctype="multipart/form-data" class="usercp_form" method="post" action="">
    <h3>{% trans %}Avatar settings{% endtrans %}</h3>
    <dl>
      <dt>{% trans %}Avatar:{% endtrans %}</dt>
      <dd><img class="usercp_avatar" src="{% if user.avatar %}{{ user.avatar.url }}{% else %}{{ href('static', 'img', 'portal', 'no_avatar.png') }}{% endif %}" alt="Avatar" /></dd>
      <dd>{{ form.avatar }}</dd>
      {%- if max_avatar_height >= 0 and max_avatar_width >= 0 %}
      <dd class="note">
        {%- trans width=max_avatar_width, height=max_avatar_height,
                 size=max_avatar_size -%}
          Please note that the maximum size for the avatar is {{ width }}x{{ height }} pixels and {{ size }} KiB. Everything that exceeds this limit will automatically be resized.
        {%- endtrans -%}
      </dd>
      {%- endif %}
      {%- if form.errors.avatar %}<dd>{{ form.errors.avatar }}</dd>{% endif %}
      <dt>{% trans %}Gravatar:{% endtrans %}</dt>
      {% if user.settings.use_gravatar %}
      <dd><img class="usercp_avatar" src="{{ user.gravatar_url }}" alt="Gravatar" /></dd>
      {% endif %}
      <dd>{{ form.use_gravatar }} <label for="id_use_gravatar">{{ form.use_gravatar.label }}</label>
        <dd class="note">{{ form.use_gravatar.help_text|safe }}</dd>
      </dd>
      <br style="clear: both;" />
    </dl>
    <h3>{% trans %}Contact addresses{% endtrans %}</h3>
    <dl>
      <dd>
        <p class="note">{% trans -%}
          The email and jabber addresses are not displayed in your public profile.
          If you want to make them public, add them to your public information.
        {%- endtrans %}</p>
      </dd>
      {% for item in ['email', 'jabber'] %}
        <dt>
          <label for="{{ form[item].auto_id }}">{{ form[item].label }}</label>
        </dt>
        <dd>{{ form[item] }}</dd>
        {%- if form.errors[item] %}<dd>{{ form.errors[item] }}</dd>{% endif %}
      {% endfor %}
    </dl>
    <h3>{% trans %}Public information{% endtrans %}</h3>
    <p class="note">{%- trans -%}You can customize your <em>public</em> profile with the fields below.{%- endtrans -%}</p>
    <table id="profile_fields">
      <thead>
        <tr>
          <td class="field">{% trans %}Field{% endtrans %}</td>
          <td class="data">{% trans %}Data{% endtrans %}</td>
          <td class="delete"></td>
        </tr>
      </thead>
      <tbody>
        {% for data in profile_data %}
          <tr>
            <td>{{ data.profile_field.title }}</td>
            <td>
              <input type="text" value="{{ data.data }}"
                     name="profile_field_{{ loop.index0 }}.{{ data.profile_field.id }}" />
              </td>
            <td>
              <a class="delete"
                 href="{{ href('portal', 'usercp', 'profile', 'delete_field', data.id) }}">Delete</a></td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="add">
            <a id="add_profile_field"
               href="{{ href('portal', 'usercp', 'profile', 'add_field') }}">Add a field</a>
          </td>
        </tr>
      </tfoot>
    </table>
    <h4>{% trans %}Geographical location{% endtrans %}</h4>
    {{ render_form(form, ['coordinates']) }}
    <h3>{% trans %}OpenIDs{% endtrans %}</h3>
    <p>
      {% if openids %}
        {% trans %}Selected openIDs will be removed!{% endtrans %}
      {% else %}
        {% trans %}No openID is associated with your account.{% endtrans %}
      {% endif %}
    </p>
    <p>{% trans -%}
      To associate an openID with your account, login with your openID.
    {%- endtrans %}</p>
    <ul>
      {% for openid in openids %}
        <li>
          <input type="checkbox" name="openids" value="{{ openid.id }}" />
          {{ openid.value }}
        </li>
      {% endfor %}
    </ul>
    <h3>{% trans %}Signature{% endtrans %}</h3>
    <p class="note">{% trans n=max_sig_length, link=href('wiki', 'ubuntuusers/Moderatoren/Forenregeln', _anchor='8-Signaturregeln') -%}
      The signature will be appended to every post. It cannot contain more than {{ n }} characters. Please follow the <a href="{{ link }}">signature rules</a>.
    {%- endtrans %}</p>
    <p>
      {{ form.signature }}
    </p>
    {{ form.errors.signature }}
    <p>
      <input type="submit" value="{% trans %}Submit{% endtrans %}" />
    </p>
    <p>
      <a href="{{ href('portal', 'user', user.username ) }}">Show my profile</a>
    </p>
  </form>
{% endblock %}

{% block additional_scripts %}
  {{ super() }}

  <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ gmaps_apikey|e }}" type="text/javascript"></script>

  <script type="text/javascript">
    /*<![CDATA[*/
    var editor = new WikiEditor('textarea[name="signature"]');

    $(function() {
      $('p.note', $('#id_coordinates').parent())
        .html('Solltest du deine Koordinaten nicht kennen gibt einfach deine ' +
              'Adresse an und klicke auf <a href="javascript:findCoords()">' +
              'Koordinaten suchen</a>.');
    });
    function findCoords() {
      var geocoder = new GClientGeocoder();
      if ($('#id_coordinates').val()) {
        var location = $('#id_coordinates').val();
      } else {
        var location = $('#id_location').val();
      }

      $('#id_coordinates').val('suche nach Koordinaten...');

      if (!location) {
        alert('Du hast keinen Ort angegeben!');
      }

      geocoder.getLatLng(location, function(p) {
        $('#id_coordinates').val(p ? p.lat() + ', ' + p.lng() : '');
      });
    }

    /*]]>*/
  </script>
  <script type="text/javascript">
    /*<![CDATA[*/
    $('#add_profile_field').click(function() {
      $('#profile_fields tbody')
      .append($('<tr>')
        .append($('<td>')
          .append($('<select>')
          )
        )
        .append($('<td>')
          .append($('<input>')
            .attr('type', 'text')
          )
        )
        .append($('<td>')
          .append($('<a>')
            .attr('class', 'delete')
            .text('Delete')
            .click(function() {
              $(this).parent().parent().remove();
            })
          )
        )
      )

      var profile_fields = eval('({{ profile_fields }})');
      var select = $('#profile_fields tbody tr:last td select')
      select.append($('<option>'));
      for (i in profile_fields) {
        select.append($('<option>')
          .attr('value', profile_fields[i].id)
          .text(profile_fields[i].title)
        );
      }
      select.change(function() {
        var row = select.parent().parent()
        var name = 'profile_field_' + row.index() + '.' + select.val();
        row.find('input').attr('name', name);
      });
      return false;
    });
    $('.delete').click(function() {
      $(this).parent().parent().remove();
      return false;
    });
    /*]]>*/
  </script>
{% endblock %}
